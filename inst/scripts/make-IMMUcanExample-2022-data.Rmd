---
title: "Prepare single-cell data, images and masks from the IMMUcan example dataset"
author: "Nils Eling"
date: "Created: Sep 14, 2022; Compiled: `r BiocStyle::doc_date()`"
output:
  BiocStyle::html_document:
    titlecaps: false
    toc_float: true
editor_options:
  chunk_output_type: console
---

```{r style, echo=FALSE, results='hide', message=FALSE}
library(BiocStyle)
knitr::opts_chunk$set(error=FALSE, message=FALSE, warning=FALSE)
```

This script loads example data acquired by the [IMMUcan](https://immucan.eu/) consortium. The data was processed as part of the [IMC data analysis book](https://bodenmillergroup.github.io/IMCDataAnalysis/) and is hosted at [zenodo.org/record/6810879](https://zenodo.org/record/6810879).   

Loading required R packages

```{r libraries}
library(SpatialExperiment)
library(cytomapper)
```

Setting the working and output directories

```{r directories}
workdir <- tempdir()

outdir <- file.path("..", "..", "inst", "extdata", "IMMUcanExample2022")
if (!(dir.exists(outdir))) dir.create(outdir)
```

# Single-cell and imaging data

Here, we will only download the already processed data and convert the spe into a sce object.

```{r download data}
options(timeout = 10000)
download.file("https://zenodo.org/record/7079294/files/spe.rds", 
              destfile = paste0(workdir, "/spe.rds"))
download.file("https://zenodo.org/record/7079294/files/images.rds", 
              destfile = paste0(outdir, "/images.rds"))
download.file("https://zenodo.org/record/7079294/files/masks.rds", 
              destfile = paste0(outdir, "/masks.rds"))

# Modify SCE object
spe <- readRDS(paste0(workdir, "spe.rds"))
sce <- as(spe, "SingleCellExperiment")
colData(sce)$cell_x <- spatialCoords(spe)[,"Pos_X"]
colData(sce)$cell_y <- spatialCoords(spe)[,"Pos_Y"]

sce$image_name <- sce$sample_id
sce$cell_number <- sce$ObjectNumber
sce$cell_id <- paste0(sce$image_name, "_", sce$cell_number)

# Fix rowData
marker_df <- data.frame(row.names = rownames(sce),
                        full_name = c("Myeloperoxidase", ),
                        short_name = c())

# Add image_name to images and masks

saveRDS(sce, paste0(outdir, "/sce.rds"))

unlink(paste0(workdir, "spe.rds"))
```

# Session information

```{r session-info}
sessionInfo()
```
